<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Display</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
    background: #eef;
  }
  #logo {
    position: fixed;
    top: 10px;
    right: 30px;
    max-width: 100px;
    max-height: 100px;
    z-index: 10;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    margin-top: 50px; /* Отступ сверху, чтобы логотип не налезал */
  }
  th, td {
    border: 1px solid #aaa;
    padding: 10px;
    text-align: center;
  }
  .timer-container {
    position: relative;
    width: 60px;
    height: 60px;
    margin: 0;
  }
  svg {
    transform: rotate(-90deg);
  }
  circle {
    fill: none;
    stroke-width: 8;
    stroke-linecap: round;
  }
  .background {
    stroke: #fff;
  }
  .progress {
    stroke: transparent !important;
    transition: stroke 0.3s;
  }
  .center-logo {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 50px;
    height: 50px;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }
  .timer-text {
    font-weight: bold;
    font-size: 14px;
    padding-left: 6px;  /* Уменьшили отступ между кругом и временем */
    vertical-align: middle;
    white-space: nowrap;
  }
</style>
</head>
<body>

<img id="logo" src="" alt="Логотип" />

<table>
  <thead>
    <tr>
      <th>Имя</th>
      <th>Фамилия</th>
      <th>Класс</th>
      <th>Таймер</th>
      <th>Комментарий</th>
    </tr>
  </thead>
  <tbody id="studentsBody"></tbody>
</table>

<script>
  const RADIUS = 26;
  const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
  const studentsBody = document.getElementById('studentsBody');
  const logoImg = document.getElementById('logo');

  // Логотип в правом верхнем углу
  const logoData = localStorage.getItem('logoImage');
  if (logoData) {
    logoImg.src = logoData;
  }

  // Иконка песочных часов (можно заменить ссылку на свой логотип часов)
  const hourglassIcon = 't.gif';

  let students = JSON.parse(localStorage.getItem('students')) || [];

  function formatTime(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  function createTimerCell(student, index) {
    const container = document.createElement('td');
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';

    const timerDiv = document.createElement('div');
    timerDiv.className = 'timer-container';

    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('width', '60');
    svg.setAttribute('height', '60');

    const bgCircle = document.createElementNS(svgNS, 'circle');
    bgCircle.classList.add('background');
    bgCircle.setAttribute('r', RADIUS);
    bgCircle.setAttribute('cx', 30);
    bgCircle.setAttribute('cy', 30);
    svg.appendChild(bgCircle);

    const progressCircle = document.createElementNS(svgNS, 'circle');
    progressCircle.classList.add('progress');
    progressCircle.setAttribute('r', RADIUS);
    progressCircle.setAttribute('cx', 30);
    progressCircle.setAttribute('cy', 30);
    progressCircle.style.strokeDasharray = CIRCUMFERENCE;
    progressCircle.style.strokeDashoffset = 0;
    svg.appendChild(progressCircle);

    timerDiv.appendChild(svg);

    // Вставляем внутрь круга иконку песочных часов
    const centerLogo = document.createElement('img');
    centerLogo.src = hourglassIcon;
    centerLogo.className = 'center-logo';
    timerDiv.appendChild(centerLogo);

    container.appendChild(timerDiv);

    // Текст времени рядом с кругом
    const timeText = document.createElement('div');
    timeText.className = 'timer-text';
    timeText.style.minWidth = '75px';
    timeText.textContent = formatTime(student.time);
    container.appendChild(timeText);

    let interval = null;

    function update() {
      const now = Date.now();
      const elapsed = Math.floor((now - student.startTimestamp) / 1000);
      let left = student.time - elapsed;
      if (left < 0) left = 0;

      timeText.textContent = formatTime(left);

      const progressPercent = left / student.time;
      progressCircle.style.strokeDashoffset = CIRCUMFERENCE * (1 - progressPercent);

      if (progressPercent <= 0.2) {
        progressCircle.style.stroke = 'red';
      } else {
        progressCircle.style.stroke = 'green';
      }
    }

    update();
    interval = setInterval(update, 1000);

    return container;
  }

  function render() {
    studentsBody.innerHTML = '';
    students.forEach((student, i) => {
      if (!student.display) return;

      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${student.name}</td>
        <td>${student.surname}</td>
        <td>${student.classNumber}</td>
        <td></td> <!-- Таймер вставим сюда -->
        <td>${student.comment || ''}</td>
      `;

      const timerCell = createTimerCell(student, i);
      tr.replaceChild(timerCell, tr.cells[3]);

      studentsBody.appendChild(tr);
    });
  }

  render();
</script>

</body>
</html>
